<?xml version="1.0"?>

<group name="FullModel" description="full pupil control model">

    <description>
        Extension of the model in Johansson and Balkenius, "A Computational Model of Pupil Dilation", Connection Science, 2017. Here we add a simplified superior colliculus and pulvinar which is assumed to detect pupil stimuli.
    </description>
    
    
    <input name="Pupil_Stimulus" targetmodule="SC" target="EXCITATION" />
    <input name="PTA_Left" targetmodule="PeripheralPupilControl" target="PTA_Left" />
    <input name="PTA_Right" targetmodule="PeripheralPupilControl" target="PTA_Right" />
    <input name="LC_Direct" targetmodule="LCa" target="EXCITATION" />
    <input name="LC_Direct" targetmodule="LCb" target="EXCITATION" />

    <output name="Pupil_Left" sourcemodule="LeftEye" source="PUPIL_DIAMETER" />
    <output name="Pupil_Right" sourcemodule="RightEye" source="PUPIL_DIAMETER" />

    <!-- parameters that can be controlled at the top level -->

    <parameter name="LCa_alpha" module="LCb" target="alpha" />
    <parameter name="LCb_alpha" module="LCb" target="alpha" />
    <parameter name="CG_alpha7" module="PeripheralPupilControl" target="CG_alpha7" default="1" />
    <parameter name="Eye_m3" module="LeftEye" target="m3" default="1" />
    <parameter name="Eye_m3" module="RightEye" target="m3" default="1" />

   <!-- ********************************* PERIPHERAL NERVOUS SYSTEM *********************************   -->

    <module
        class="BilateralPeripheralPupilControl"
        name="PeripheralPupilControl"
    />

    <!-- ********************************* SC / PULV *********************************   -->

    <module
        class="Nucleus"
        name="SC"
    />

    <module
        class="Nucleus"
        name="PULV"
        beta="1"
    />

    <connection sourcemodule="SC" source="OUTPUT" targetmodule="PULV" target="EXCITATION" />
    <connection sourcemodule="PULV" source="OUTPUT" targetmodule="LCa" target="EXCITATION" />     <!-- We pass through amygdala since US gives no UR in delta rule model -->
    <connection sourcemodule="PULV" source="OUTPUT" targetmodule="LCb" target="EXCITATION" />     <!-- We pass through amygdala since US gives no UR in delta rule model -->

   <!-- ********************************* LOCUS COERULEUS *********************************   -->

    <module
        class="Nucleus"
        name="LCa"
        beta="0.05"
        alpha="0.8"
    />

    <module
        class="Nucleus"
        name="LCb"
        beta="0.05"
    />

    <!-- LC => IML -->
    
    <connection sourcemodule="LCa" source="OUTPUT" targetmodule="PeripheralPupilControl" target="IML_EXCITATION_Left" />
    <connection sourcemodule="LCa" source="OUTPUT" targetmodule="PeripheralPupilControl" target="IML_EXCITATION_Right" />

    <connection sourcemodule="LCb" source="OUTPUT" targetmodule="PeripheralPupilControl" target="EW_SHUNTING_Left" />
    <connection sourcemodule="LCb" source="OUTPUT" targetmodule="PeripheralPupilControl" target="EW_SHUNTING_Right" />

    <!-- ********************************* AMYGDALA ********************************* -->
    
    <_connection sourcemodule="VisionBlackBock" source="OBJECT" targetmodule="Amygdala" target="CS" delay="105" />
    <_connection sourcemodule="VisionBlackBock" source="EMOTION_NEG" targetmodule="Amygdala" target="US" />

    <module
        class="Amygdala"
        name="Amygdala"
        alpha = "0.05"
    />

    <connection sourcemodule="Amygdala" source="CR" targetmodule="LCa" target="EXCITATION" />    <!-- CR OUTPUT -->
    <connection sourcemodule="Amygdala" source="CR" targetmodule="LCb" target="EXCITATION" />    <!-- CR OUTPUT -->

    <!-- ********************************* CERBELLUM ********************************* -->
    
    <_connection sourcemodule="VisionBlackBock" source="OBJECT" targetmodule="Cerebellum" target="CS" />    <!-- CS INPUT -->

    <connection sourcemodule="PeripheralPupilControl" source="EW_OUTPUT_Left" targetmodule="Cerebellum_Left" target="US" />    <!-- US INPUT (target) -->
    <connection sourcemodule="PeripheralPupilControl" source="EW_OUTPUT_Right" targetmodule="Cerebellum_Right" target="US" />    <!-- US INPUT (target) -->

    <module
        class="Cerebellum"
        name="Cerebellum_Left"
        alpha = "0.1"
    />

    <module
        class="Cerebellum"
        name="Cerebellum_Right"
        alpha = "0.1"
    />

    <connection sourcemodule="Cerebellum_Left" source="CR" targetmodule="PeripheralPupilControl" target="EW_EXCITATION_Left" />    <!-- CR OUTPUT -->
    <connection sourcemodule="Cerebellum_Right" source="CR" targetmodule="PeripheralPupilControl" target="EW_EXCITATION_Right" />    <!-- CR OUTPUT -->

    <!-- ********************************* EYES ********************************* -->
    
    <!-- delay = 12 gives a minumum 260 ms latency of pupilary response -->

    <connection sourcemodule="PeripheralPupilControl" source="SCG_OUTPUT_Left" targetmodule="LeftEye" target="PUPIL_DILATOR" delay="12" />
    <connection sourcemodule="PeripheralPupilControl" source="CG_OUTPUT_Left" targetmodule="LeftEye" target="PUPIL_SPHINCTER" delay="12" />

    <connection sourcemodule="PeripheralPupilControl" source="SCG_OUTPUT_Right" targetmodule="RightEye" target="PUPIL_DILATOR" delay="12" />
    <connection sourcemodule="PeripheralPupilControl" source="CG_OUTPUT_Right" targetmodule="RightEye" target="PUPIL_SPHINCTER"delay="12" />

    <module
        class = "EyeModel"
        name = "LeftEye"
        epsilon = "0.1"
        pupil_min = "0.2"
        pupil_max = "2.0"
    />
    
    <module
        class = "EyeModel"
        name = "RightEye"
        epsilon = "0.1"
        pupil_min = "0.2"
        pupil_max = "2.0"
    />
    
    
    <!-- ********************************* VIEW ********************************* -->
    
    <view name="View (Default)">
    
        <plot
            source="*.Eye_Left"
            color="red"
            lineWidth = "3"
            max="1"
            x="20" y="20"
            height="200" width="600"
        />

        <plot
            source="*.Eye_Right"
            color="blue"
            lineWidth = "3"
            max="1"
            x="20" y="200"
            height="200" width="600"
        />

    </view>
</group>

